<!doctype html>
<html>

<head>
    <meta name="ac:route" content="/">
    <script src="dmxAppConnect/dmxAppConnect.js"></script>
    <base href="/">
    <meta charset="UTF-8">
    <title>Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="js/jquery-3.4.1.slim.min.js"></script>
    <link rel="stylesheet" href="fontawesome4/css/font-awesome.min.css" />
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="dmxAppConnect/dmxValidator/dmxValidator.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js" integrity="sha256-CutOzxCRucUsn6C6TcEYsauvvYilEniTXldPa6/wu0k=" crossorigin="anonymous"></script>
    <script src="dmxAppConnect/dmxValidator/dmxValidator.js" defer=""></script>
    <link rel="stylesheet" href="dmxAppConnect/dmxDatePicker/daterangepicker.min.css" />
    <script src="dmxAppConnect/dmxDatePicker/daterangepicker.min.js" defer=""></script>
    <link rel="stylesheet" href="dmxAppConnect/dmxDatePicker/dmxDatePicker.css" />
    <script src="dmxAppConnect/dmxDatePicker/dmxDatePicker.js" defer=""></script>

    <script src="dmxAppConnect/dmxFormatter/dmxFormatter.js" defer=""></script>
    <link rel="stylesheet" href="dmxAppConnect/dmxBootstrap4TableGenerator/dmxBootstrap4TableGenerator.css" />
    <link rel="stylesheet" href="../dmxAppConnect/dmxDatePicker/bgthemes/dark-calendar.css" />
    <link rel="stylesheet" href="bootstrap/4/minty/bootstrap.min.css" />
    <link rel="stylesheet" href="dmxAppConnect/dmxNotifications/dmxNotifications.css" />
    <script src="dmxAppConnect/dmxNotifications/dmxNotifications.js" defer=""></script>
    <script src="dmxAppConnect/dmxBootstrap4Alert/dmxBootstrap4Alert.js" defer=""></script>
    <script src="dmxAppConnect/dmxBootstrap4Tooltips/dmxBootstrap4Tooltips.js" defer=""></script>
</head>

<body is="dmx-app" id="index">
    <dmx-array id="detailsForTable"></dmx-array>

    <dmx-array id="usersForTable"></dmx-array>
    <dmx-notifications id="notifies" position="bottom"></dmx-notifications>
    <dmx-serverconnect id="insert_consumption" url="api/Insert/insert_consumption" noload dmx-on:success="notifies.success('Consumption registered');get_users.load({},true);get_dates.load({},true);get_entries.load({},true)"
        dmx-on:error="notifies.danger('Check your input')">
    </dmx-serverconnect>

    <dmx-serverconnect id="get_drugs" url="api/Details/get_drugs"></dmx-serverconnect>
    <dmx-serverconnect id="get_users" url="api/Details/get_users" dmx-on:success="usersForTable.add(get_users.data.query);get_entries.load({},true)"></dmx-serverconnect>

    <dmx-serverconnect id="get_entries" url="api/Details/get_entries" dmx-on:success="run([{run:{action:`detailsForTable.add(get_entries.data.combined)`}},{runJS:{function:'createTable'}}])" noload></dmx-serverconnect>
    <dmx-serverconnect id="get_dates" url="api/Details/get_dates"></dmx-serverconnect>
    <section class="container-fluid" id="header">
        <header class="navbar-light pt-1 pb-1 sticky-top">
            <h3 class="mt-0 mb-0 pt-0 pb-0 text-monospace text-left font-weight-bold">V.A.G.I.N.A - Drug App</h3>
        </header>
    </section>
    <section id="input" class="container-fluid mt-2 mb-0">


        <dmx-array id="selection" dmx-on:updated="run({runJS:{function:'logThis'}})"></dmx-array>
        <dmx-value id="UserSelection"></dmx-value>
        <h4 class="style1">Submit a drug consumption</h4>
        <div class="row">
            <div class="col-2 pr-0">
                <select id="user" class="form-control" name="user" dmx-bind:options="get_users.data.query" optiontext="first_name+' '+last_name" optionvalue="id" data-msg-required="" dmx-on:updated="UserSelection.setValue(value)">
                    <option selected="" value="">Select user</option>
                </select>
                <button id="add" class="btn btn-outline-success mt-3" dmx-on:click="insert_consumption.load({id: UserSelection.value, drugs: selection.items, date: date.value})">Submit</button></div>
            <div class="col-NaN col-1 ml-3">
                <div class="row row-cols-1" is="dmx-repeat" id="repeat1" dmx-bind:repeat="get_drugs.data.query" key="id">
                    <div class="col ml-3 pl-0 pr-0">
                        <script is="dmx-flow" id="flow" type="text/dmx-flow">{
  condition: {
    if: "{{checked.value == 0}}",
    then: {
      steps: {
        run: {action: "{{selection.add(name);checked.setValue(1)}}"}
      }
    },
    else: {
      steps: {
        run: {action: "{{selection.remove(name);checked.setValue(0)}}"}
      }
    }
  }
}</script>
                        <dmx-value id="checked" dmx-bind:value="0"></dmx-value>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="input1" name="input1" dmx-on:click="run({run:{action:`flow.run({})`}})" dmx-bind:value="name">
                            <label class="form-check-label" for="input1" dmx-text="name">Default checkbox</label>
                        </div>

                    </div>
                </div>
            </div>
            <div class="col-NaN ml-5 pl-0">
                <input id="date" name="date" is="dmx-date-picker" placeholder="Select date" opens="center" data-msg-required="">
            </div>
        </div>
    </section>
    <section id="view" class="container-fluid mt-3">





        <h4 class="style1">Consumption log</h4>
        <div class="row" id="first">
            <div class="col border-right border-bottom">
                <h6 class="text-center">Date</h6>
            </div>
            <div class="col text-center border-right border-bottom" dmx-repeat:some="get_users.data.query">
                <h6 dmx-text="first_name" class="flex-shrink-1"></h6>
            </div>
        </div>
    </section>
    <script src="bootstrap/4/js/popper.min.js"></script>
    <script src="bootstrap/4/js/bootstrap.min.js"></script>
    <script>
        var index = 0;
        var GLOBAL_DETAILS = [];
        var GLOBAL_USERS = [];
        var PROCESSED_DATES = [];
        var COLOR_SHADING_STRENGTH = 5;//percentage increment for more consumption
        
        function resetVariables(){
            dmx.parse('detailsForTable.empty()');
            dmx.parse('usersForTable.empty()');
            PROCESSED_DATES = [];
            GLOBAL_DETAILS = [];
            GLOBAL_USERS = [];
        }

        function clearTable(){

        }
        
        function shadeColor(color, percent) {

            var R = parseInt(color.substring(1,3),16);
            var G = parseInt(color.substring(3,5),16);
            var B = parseInt(color.substring(5,7),16);

            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);

            R = (R<255)?R:255;  
            G = (G<255)?G:255;  
            B = (B<255)?B:255;  

            var RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
            var GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
            var BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));

            return "#"+RR+GG+BB;
        }
        function logThis(){
            // <h5 dmx-text="get_entries.data.combined[0].drugs" dmx-bs-tooltip="drugs">Fancy display heading</h5>
            var x = dmx.parse('selection.items');
            console.log('items: ', x);
        }
        

        function createTable(){

            GLOBAL_USERS = dmx.parse('usersForTable.items');
            GLOBAL_DETAILS = dmx.parse('detailsForTable.items');
            // console.log(GLOBAL_USERS);
            var uniqueIndex = 0;

            // console.log(GLOBAL_DETAILS);

            while(index < GLOBAL_DETAILS[0].length){
                var date = GLOBAL_DETAILS[0][index].date; //.slice(0, 10);
                // console.log('processing date:', date.slice(0, 10));

                if(PROCESSED_DATES.indexOf(date) == -1){
                    rowForDate(date, uniqueIndex);
                    PROCESSED_DATES.push(date);
                    uniqueIndex++;
                }

                index++;
            }
            index = 0;
            uniqueIndex = 0;
            resetVariables();
        }

        function rowForDate(date, index){
            var userID = 0;

            var row = document.createElement('div');
            var dateElement = document.createElement('div');
            var dateValue = document.createElement('h6');

            row.id = 'tableRow'+index;
            row.className = 'row';
            dateElement.className = 'col border-right text-center';
            dateValue.innerHTML = reverseDate(date.slice(0, 10));

            dateElement.appendChild(dateValue);
            row.appendChild(dateElement);

            for(var i = 0; i < GLOBAL_USERS[0].length; i++){
                var col = document.createElement('div');
                col.className = 'col border-right text-center';
                col.id = 'tableColumn'+index+''+i;
                userID = GLOBAL_USERS[0][i].id;
                var drugs = findDetailsForUser(userID, date);
                var text = document.createElement('h6');
                text.className = 'text-center';

                if(drugs != null){
                    var dr = drugs.split(',');
                    text.innerHTML = dr.length;
                    // col.className = 'col border-right text-center tooltip';
                    col.style.backgroundColor = shadeColor('#e6ffe6', -dr.length*COLOR_SHADING_STRENGTH);
                    // var span = document.createElement('span');
                    // span.className = 'tooltiptext';
                    // span.innerHTML = drugs;
                    // col.appendChild(span);
                    // text.setAttribute('dmx-bs-tooltip', drugs);
                } else {
                    text.innerHTML = 0;
                }
                
                col.appendChild(text);
                row.appendChild(col);
                // console.log(drugs, 'for', userID);
                
            }
            if(index == 0){
                var toAppendAfter = document.getElementById('first');
                insertAfter(row, toAppendAfter);
                // console.log('inserted new row...');
            } else {
                var previous = index - 1;
                var toAppendAfter = document.getElementById('tableRow'+previous);
                insertAfter(row, toAppendAfter);
                // console.log('inserted new row...');
            }
            
        }

        function insertAfter(newNode, existingNode) {
            existingNode.parentNode.insertBefore(newNode, existingNode.nextSibling);
        }

        function findDetailsForUser(userID, date){
            // console.log('finding details for user', userID, 'on', date);
            for(var j = 0; j < GLOBAL_DETAILS[0].length; j++){
                if(userID == GLOBAL_DETAILS[0][j].id && date == GLOBAL_DETAILS[0][j].date){
                    // console.log('found...');
                    return GLOBAL_DETAILS[0][j].drugs;
                }
            }
            // console.log('didnt find...');
            return null;
        }

        function reverseDate(date){
            var year = date.slice(0, 4);
            var month = date.slice(5, 7);
            var day = date.slice(8, 10);
            return day+'-'+month+'-'+year;
        }

    </script>
</body>

</html>